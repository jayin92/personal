{{- $authorIds := .Get "authors" | default "" -}}
{{- $equalContrib := .Get "equal" | default "" -}}
{{- $authors := .Site.Data.authors.authors -}}

<div class="publication-with-teaser">
  <div class="publication-teaser">
    <div class="teaser-container">
      <img src="{{ .Get "image" }}" alt="{{ .Get "title" }} teaser image" class="teaser-image">
      {{- $hoverMedia := .Get "video" | default (.Get "hoverImage") -}}
      {{ if $hoverMedia }}
        <span class="teaser-hint">â–¶ Hover / Tap</span>
        {{- $isImage := or (strings.HasSuffix $hoverMedia ".jpg") (strings.HasSuffix $hoverMedia ".jpeg") (strings.HasSuffix $hoverMedia ".png") (strings.HasSuffix $hoverMedia ".gif") (strings.HasSuffix $hoverMedia ".webp") -}}
        {{ if $isImage }}
        <img src="{{ $hoverMedia }}" alt="{{ .Get "title" }} hover image" class="teaser-hover-image teaser-video">
        <script>
          (function() {
            const container = document.currentScript.parentElement;
            container.addEventListener('click', function() {
              container.classList.toggle('active');
            });
          })();
        </script>
        {{ else }}
        <video class="teaser-video" muted loop playsinline>
          <source src="{{ $hoverMedia }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        <script>
          (function() {
            const container = document.currentScript.parentElement;
            const video = container.querySelector('video.teaser-video');
            if (video) {
              let playPromise;
              let isPlaying = false;
              const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
              
              function playVideo() {
                isPlaying = true;
                container.classList.add('active');
                playPromise = video.play();
              }
              
              function stopVideo() {
                isPlaying = false;
                container.classList.remove('active');
                if (playPromise !== undefined) {
                  playPromise.then(function() {
                    video.pause();
                    video.currentTime = 0;
                  }).catch(function() {});
                }
              }
              
              // Desktop: hover to play
              if (!isTouchDevice) {
                container.addEventListener('mouseenter', playVideo);
                container.addEventListener('mouseleave', stopVideo);
              }
              
              // Mobile: tap to toggle
              container.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (isPlaying) {
                  stopVideo();
                } else {
                  playVideo();
                }
              });
            }
          })();
        </script>
        {{ end }}
      {{ end }}
    </div>
  </div>
  <div class="publication-content">
    {{ if and (.Get "url") (.Get "title") (.Get "venue") (.Get "year") }}
      <div class="publication-meta">
        <a href="{{ .Get "url" }}" target="_blank" rel="noopener noreferrer" class="publication-title">{{ .Get "title" }}</a>
        <br>
        {{ if $authorIds }}
        <span class="authors">
          {{- $authorIdList := split $authorIds "," -}}
          {{- $equalContribList := split $equalContrib "," -}}
          {{- range $index, $authorId := $authorIdList -}}
            {{- $authorId := trim $authorId " " -}}
            {{- $isEqual := false -}}
            {{- range $equalId := $equalContribList -}}
              {{- if eq (trim $equalId " ") $authorId -}}
                {{- $isEqual = true -}}
              {{- end -}}
            {{- end -}}
            {{- if gt $index 0 -}},&nbsp;{{- end -}}
            {{- $author := index (where $authors "id" $authorId) 0 -}}
            {{- if $author -}}
              {{- if $author.highlight -}}
                <strong>
                  {{- if $author.url -}}
                    <a href="{{ $author.url }}" target="_blank" rel="noopener noreferrer">{{ $author.name }}</a>
                  {{- else -}}
                    {{ $author.name }}
                  {{- end -}}
                </strong>
              {{- else -}}
                {{- if $author.url -}}
                  <a href="{{ $author.url }}" target="_blank" rel="noopener noreferrer">{{ $author.name }}</a>
                {{- else -}}
                  {{ $author.name }}
                {{- end -}}
              {{- end -}}
              {{- if $isEqual -}}*{{- end -}}
            {{- else -}}
              {{ $authorId }}
            {{- end -}}
          {{- end -}}
          {{- if ne $equalContrib "" -}}
            {{- $note := .Get "note" | default "(*Equal Contribution)" -}}
            {{- printf " %s" $note -}}
          {{- end -}}
        </span>
        {{ end }}
        <br>
        <em class="venue">{{ .Get "venue" }}{{ with .Get "venue-short" }} <strong>({{ . }})</strong>{{ end }}, {{ .Get "year" }}</em>
        {{/* Links using named parameters */}}
        {{- $hasLinks := or (.Get "project") (.Get "arxiv") (.Get "code") (.Get "pdf") (.Get "video-link") (.Get "demo") -}}
        {{ if $hasLinks }}
        <br>
        <span class="publication-links">
          {{- $first := true -}}
          {{- with .Get "project" -}}
            {{- if not $first }} / {{ end -}}<a href="{{ . }}" target="_blank" rel="noopener noreferrer">project page</a>
            {{- $first = false -}}
          {{- end -}}
          {{- with .Get "arxiv" -}}
            {{- if not $first }} / {{ end -}}<a href="{{ . }}" target="_blank" rel="noopener noreferrer">arXiv</a>
            {{- $first = false -}}
          {{- end -}}
          {{- with .Get "pdf" -}}
            {{- if not $first }} / {{ end -}}<a href="{{ . }}" target="_blank" rel="noopener noreferrer">pdf</a>
            {{- $first = false -}}
          {{- end -}}
          {{- with .Get "code" -}}
            {{- if not $first }} / {{ end -}}<a href="{{ . }}" target="_blank" rel="noopener noreferrer">code</a>
            {{- $first = false -}}
          {{- end -}}
          {{- with .Get "video-link" -}}
            {{- if not $first }} / {{ end -}}<a href="{{ . }}" target="_blank" rel="noopener noreferrer">video</a>
            {{- $first = false -}}
          {{- end -}}
          {{- with .Get "demo" -}}
            {{- if not $first }} / {{ end -}}<a href="{{ . }}" target="_blank" rel="noopener noreferrer">demo</a>
            {{- $first = false -}}
          {{- end -}}
        </span>
        {{ end }}
      </div>

      {{ if .Inner }}
        <div class="publication-abstract">
          {{ .Inner | markdownify }}
        </div>
      {{ end }}
    {{ else }}
      {{ .Inner | markdownify }}
    {{ end }}
  </div>
</div>
